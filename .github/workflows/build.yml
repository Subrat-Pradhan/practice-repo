name: Cypress CI Parallel
on: [push]

jobs:
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          command: npm run cypress:smoke
        continue-on-error: true

      - name: Upload Smoke Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report
          path: cypress/reports/html

  regression-test:
    name: Regression Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2] # Splitting tests into 2 parallel runners
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cypress run (Parallel)
        uses: cypress-io/github-action@v6
        with:
          # Manual split of specs for parallel execution without dashboard
          command: |
            if [ "${{ matrix.group }}" == "1" ]; then
              npx cypress run --spec "cypress-learning/e2e/comprehensive_learning.cy.js,cypress-learning/e2e/demo_web_shop.cy.js"
            else
              npx cypress run --spec "cypress-learning/e2e/test1.cy.js,cypress-learning/e2e/unit-tc/**/*.cy.js"
            fi
        continue-on-error: true

      - name: Upload Regression Report Group ${{ matrix.group }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-report-group-${{ matrix.group }}
          path: cypress/reports/html

  notify:
    name: Email Notification
    runs-on: ubuntu-latest
    needs: [smoke-test, regression-test]
    if: always()
    steps:
      - name: Send Summary Email
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP settings (You need to add these secrets to your repo)
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "Cypress CI Report: ${{ github.repository }} - ${{ job.status }}"
          to: subratkp27@gmail.com
          from: "Cypress Automated CI"
          body: |
            Cypress test execution has completed!

            Workflow: ${{ github.workflow }}
            Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            View full details and download reports here:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Note: If tests failed, you can find detailed HTML reports and screenshots in the "Artifacts" section of the run link above.